import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Plus, Calendar, Clock, MessageSquare, Check, Archive, Filter, Search, Star, Trash2, Edit3, Send, ChevronDown, Target, Activity, Bell, BellOff, Repeat, AlertTriangle, Zap, Settings, Download, Upload } from 'lucide-react';

const UltimateTaskPlanner = () => {
  const [tasks, setTasks] = useState([]);
  const [filter, setFilter] = useState('active'); // active, completed, recurring, all
  const [searchTerm, setSearchTerm] = useState('');
  const [showAddForm, setShowAddForm] = useState(false);
  const [editingTask, setEditingTask] = useState(null);
  const [notificationsEnabled, setNotificationsEnabled] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [settings, setSettings] = useState({
    notifications: true,
    sound: true,
    reminderMinutes: [5, 15, 60], // –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ 5–º–∏–Ω, 15–º–∏–Ω, 1—á–∞—Å
    autoSort: true,
    theme: 'light'
  });
  const [newTask, setNewTask] = useState({
    title: '',
    description: '',
    priority: 'medium',
    dueDate: '',
    category: 'personal',
    isRecurring: false,
    recurringType: 'daily', // daily, weekly, monthly
    reminderEnabled: true
  });

  const notificationTimeouts = useRef(new Map());
  const audioRef = useRef(null);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  useEffect(() => {
    const savedTasks = localStorage.getItem('taskmaster_tasks');
    const savedSettings = localStorage.getItem('taskmaster_settings');
    
    if (savedTasks) {
      try {
        const parsedTasks = JSON.parse(savedTasks);
        setTasks(parsedTasks.map(task => ({
          ...task,
          createdAt: new Date(task.createdAt),
          dueDate: task.dueDate ? new Date(task.dueDate) : null,
          completedAt: task.completedAt ? new Date(task.completedAt) : null,
          comments: task.comments?.map(comment => ({
            ...comment,
            timestamp: new Date(comment.timestamp)
          })) || []
        })));
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á:', error);
      }
    } else {
      // –ü—Ä–∏–º–µ—Ä—ã –∑–∞–¥–∞—á –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
      const sampleTasks = [
        {
          id: 1,
          title: 'üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ TaskMaster Pro!',
          description: '–ò–∑—É—á–∏—Ç–µ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.',
          priority: 'high',
          status: 'active',
          category: 'personal',
          createdAt: new Date(),
          dueDate: new Date(Date.now() + 2 * 60 * 60 * 1000), // —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞
          reminderEnabled: true,
          isRecurring: false,
          comments: [
            { id: 1, text: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!', timestamp: new Date() }
          ]
        },
        {
          id: 2,
          title: '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∑–∞—Ä—è–¥–∫–∞',
          description: '15 –º–∏–Ω—É—Ç —É—Ç—Ä–µ–Ω–Ω–µ–π –∑–∞—Ä—è–¥–∫–∏ –¥–ª—è –±–æ–¥—Ä–æ—Å—Ç–∏ –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å',
          priority: 'medium',
          status: 'active',
          category: 'health',
          createdAt: new Date(),
          dueDate: null,
          reminderEnabled: true,
          isRecurring: true,
          recurringType: 'daily',
          comments: []
        }
      ];
      setTasks(sampleTasks);
    }

    if (savedSettings) {
      try {
        setSettings(JSON.parse(savedSettings));
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
      }
    }
  }, []);

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
  useEffect(() => {
    localStorage.setItem('taskmaster_tasks', JSON.stringify(tasks));
  }, [tasks]);

  useEffect(() => {
    localStorage.setItem('taskmaster_settings', JSON.stringify(settings));
  }, [settings]);

  // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  useEffect(() => {
    if ('Notification' in window && settings.notifications) {
      if (Notification.permission === 'granted') {
        setNotificationsEnabled(true);
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
          setNotificationsEnabled(permission === 'granted');
        });
      }
    }
  }, [settings.notifications]);

  // –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  useEffect(() => {
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–∞–π–º–µ—Ä—ã
    notificationTimeouts.current.forEach(timeout => clearTimeout(timeout));
    notificationTimeouts.current.clear();

    if (!notificationsEnabled || !settings.notifications) return;

    tasks.filter(task => task.status === 'active' && task.reminderEnabled && task.dueDate).forEach(task => {
      const now = new Date();
      const dueDate = new Date(task.dueDate);
      
      settings.reminderMinutes.forEach(minutes => {
        const reminderTime = new Date(dueDate.getTime() - minutes * 60 * 1000);
        const timeToReminder = reminderTime.getTime() - now.getTime();
        
        if (timeToReminder > 0) {
          const timeoutId = setTimeout(() => {
            showNotification(task, minutes);
          }, timeToReminder);
          
          notificationTimeouts.current.set(`${task.id}-${minutes}`, timeoutId);
        }
      });

      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ—Å—Ä–æ—á–∫–µ
      if (dueDate.getTime() < now.getTime()) {
        const overdueMins = Math.floor((now.getTime() - dueDate.getTime()) / (1000 * 60));
        if (overdueMins <= 60) { // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞ –ø–æ—Å–ª–µ –ø—Ä–æ—Å—Ä–æ—á–∫–∏
          showNotification(task, 0, true);
        }
      }
    });

    return () => {
      notificationTimeouts.current.forEach(timeout => clearTimeout(timeout));
      notificationTimeouts.current.clear();
    };
  }, [tasks, notificationsEnabled, settings]);

  const showNotification = (task, minutesBefore, isOverdue = false) => {
    if (!notificationsEnabled) return;

    const title = isOverdue ? '‚ö†Ô∏è –ó–∞–¥–∞—á–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞!' : '‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–¥–∞—á–µ';
    const body = isOverdue 
      ? `"${task.title}" –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∞`
      : minutesBefore === 0 
        ? `–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å: "${task.title}"`
        : `–ß–µ—Ä–µ–∑ ${minutesBefore} –º–∏–Ω: "${task.title}"`;

    const notification = new Notification(title, {
      body,
      icon: '/favicon.ico',
      badge: '/favicon.ico',
      tag: `task-${task.id}`,
      requireInteraction: isOverdue,
      actions: [
        { action: 'complete', title: '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ' },
        { action: 'snooze', title: '‚è∞ –û—Ç–ª–æ–∂–∏—Ç—å' }
      ]
    });

    if (settings.sound && audioRef.current) {
      audioRef.current.play().catch(() => {});
    }

    notification.onclick = () => {
      window.focus();
      notification.close();
    };

    // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    setTimeout(() => notification.close(), 10000);
  };

  const addTask = () => {
    if (!newTask.title.trim()) return;
    
    const task = {
      id: Date.now(),
      ...newTask,
      status: 'active',
      createdAt: new Date(),
      dueDate: newTask.dueDate ? new Date(newTask.dueDate) : null,
      comments: [],
      lastRecurrence: newTask.isRecurring ? new Date() : null
    };
    
    setTasks([task, ...tasks]);
    setNewTask({ 
      title: '', 
      description: '', 
      priority: 'medium', 
      dueDate: '', 
      category: 'personal',
      isRecurring: false,
      recurringType: 'daily',
      reminderEnabled: true
    });
    setShowAddForm(false);
  };

  const updateTask = (taskId, updates) => {
    setTasks(tasks.map(task => 
      task.id === taskId ? { ...task, ...updates } : task
    ));
  };

  const addComment = (taskId, commentText) => {
    if (!commentText.trim()) return;
    
    const comment = {
      id: Date.now(),
      text: commentText,
      timestamp: new Date()
    };
    
    updateTask(taskId, {
      comments: [...(tasks.find(t => t.id === taskId)?.comments || []), comment]
    });
  };

  const toggleTaskStatus = (taskId) => {
    const task = tasks.find(t => t.id === taskId);
    const newStatus = task.status === 'active' ? 'completed' : 'active';
    
    let updates = { 
      status: newStatus,
      completedAt: newStatus === 'completed' ? new Date() : null
    };

    // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –∏ –µ—ë –∑–∞–≤–µ—Ä—à–∏–ª–∏
    if (task.isRecurring && newStatus === 'completed') {
      const nextDueDate = calculateNextRecurrence(task.dueDate, task.recurringType);
      updates = {
        ...updates,
        status: 'active', // –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–¥–∞—á–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏
        completedAt: null,
        dueDate: nextDueDate,
        lastRecurrence: new Date(),
        comments: [...task.comments, {
          id: Date.now(),
          text: `‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ ${formatDate(new Date())}`,
          timestamp: new Date()
        }]
      };
    }
    
    updateTask(taskId, updates);
  };

  const calculateNextRecurrence = (currentDate, type) => {
    if (!currentDate) return new Date();
    
    const nextDate = new Date(currentDate);
    switch(type) {
      case 'daily':
        nextDate.setDate(nextDate.getDate() + 1);
        break;
      case 'weekly':
        nextDate.setDate(nextDate.getDate() + 7);
        break;
      case 'monthly':
        nextDate.setMonth(nextDate.getMonth() + 1);
        break;
    }
    return nextDate;
  };

  const deleteTask = (taskId) => {
    setTasks(tasks.filter(task => task.id !== taskId));
  };

  const exportTasks = () => {
    const dataStr = JSON.stringify({ tasks, settings, exportDate: new Date() }, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `taskmaster-backup-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
  };

  const importTasks = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (data.tasks) {
          const importedTasks = data.tasks.map(task => ({
            ...task,
            id: task.id + Date.now(), // –ò–∑–±–µ–≥–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ ID
            createdAt: new Date(task.createdAt),
            dueDate: task.dueDate ? new Date(task.dueDate) : null,
            completedAt: task.completedAt ? new Date(task.completedAt) : null,
            comments: task.comments?.map(comment => ({
              ...comment,
              timestamp: new Date(comment.timestamp)
            })) || []
          }));
          setTasks([...importedTasks, ...tasks]);
        }
        if (data.settings) {
          setSettings({ ...settings, ...data.settings });
        }
        alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞');
      }
    };
    reader.readAsText(file);
  };

  // –£–º–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞–¥–∞—á
  const sortTasks = (tasksToSort) => {
    if (!settings.autoSort) return tasksToSort;
    
    return [...tasksToSort].sort((a, b) => {
      // 1. –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞–≤–µ—Ä—Ö
      const aOverdue = a.dueDate && new Date(a.dueDate) < new Date() && a.status === 'active';
      const bOverdue = b.dueDate && new Date(b.dueDate) < new Date() && b.status === 'active';
      if (aOverdue && !bOverdue) return -1;
      if (!aOverdue && bOverdue) return 1;
      
      // 2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
      const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
      const priorityDiff = priorityOrder[b.priority] - priorityOrder[a.priority];
      if (priorityDiff !== 0) return priorityDiff;
      
      // 3. –î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
      if (a.dueDate && b.dueDate) {
        return new Date(a.dueDate) - new Date(b.dueDate);
      }
      if (a.dueDate && !b.dueDate) return -1;
      if (!a.dueDate && b.dueDate) return 1;
      
      // 4. –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –Ω–∞–≤–µ—Ä—Ö)
      return new Date(b.createdAt) - new Date(a.createdAt);
    });
  };

  const filteredTasks = sortTasks(tasks.filter(task => {
    const matchesFilter = filter === 'all' || 
                         (filter === 'active' && task.status === 'active' && !task.isRecurring) ||
                         (filter === 'completed' && task.status === 'completed') ||
                         (filter === 'recurring' && task.isRecurring);
    
    const matchesSearch = task.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         task.description.toLowerCase().includes(searchTerm.toLowerCase());
    
    return matchesFilter && matchesSearch;
  }));

  const getPriorityColor = (priority) => {
    switch(priority) {
      case 'high': return 'bg-red-500';
      case 'medium': return 'bg-yellow-500';
      case 'low': return 'bg-green-500';
      default: return 'bg-gray-500';
    }
  };

  const getCategoryIcon = (category) => {
    switch(category) {
      case 'work': return 'üíº';
      case 'personal': return 'üè†';
      case 'health': return 'üí™';
      case 'study': return 'üìö';
      default: return 'üìù';
    }
  };

  const formatDate = (date) => {
    if (!date) return '';
    return new Intl.DateTimeFormat('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(new Date(date));
  };

  const isOverdue = (dueDate) => {
    return dueDate && new Date(dueDate) < new Date();
  };

  const getTaskStats = () => {
    const total = tasks.length;
    const active = tasks.filter(t => t.status === 'active').length;
    const completed = tasks.filter(t => t.status === 'completed').length;
    const overdue = tasks.filter(t => isOverdue(t.dueDate) && t.status === 'active').length;
    const recurring = tasks.filter(t => t.isRecurring).length;
    
    return { total, active, completed, overdue, recurring };
  };

  const stats = getTaskStats();

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-cyan-50">
      {/* Audio —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∑–≤—É–∫–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */}
      <audio ref={audioRef} preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgfDGK/8+OZURE" type="audio/wav" />
      </audio>

      {/* Header */}
      <div className="bg-white/80 backdrop-blur-md border-b border-gray-200 sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-2 rounded-xl">
                <Target className="w-6 h-6" />
              </div>
              <div>
                <h1 className="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                  TaskMaster Pro
                </h1>
                <div className="flex items-center space-x-4 text-sm text-gray-600">
                  <span>üìä {stats.active} –∞–∫—Ç–∏–≤–Ω—ã—Ö</span>
                  {stats.overdue > 0 && (
                    <span className="text-red-500 font-medium">‚ö†Ô∏è {stats.overdue} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                  )}
                  <span>üîÑ {stats.recurring} –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö</span>
                </div>
              </div>
            </div>
            
            <div className="flex items-center space-x-2">
              <button
                onClick={() => setShowSettings(true)}
                className="p-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors duration-200"
                title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
              >
                <Settings className="w-5 h-5" />
              </button>
              
              <button
                onClick={() => setNotificationsEnabled(!notificationsEnabled)}
                className={`p-2 rounded-lg transition-colors duration-200 ${
                  notificationsEnabled 
                    ? 'text-green-600 bg-green-50' 
                    : 'text-gray-400 hover:text-gray-600 hover:bg-gray-50'
                }`}
                title={notificationsEnabled ? '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã' : '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã'}
              >
                {notificationsEnabled ? <Bell className="w-5 h-5" /> : <BellOff className="w-5 h-5" />}
              </button>
              
              <button
                onClick={() => setShowAddForm(true)}
                className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-xl flex items-center space-x-2 hover:shadow-lg transform hover:scale-105 transition-all duration-200"
              >
                <Plus className="w-5 h-5" />
                <span>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-4xl mx-auto px-4 py-6">
        {/* Controls */}
        <div className="bg-white/60 backdrop-blur-sm rounded-2xl p-4 mb-6 border border-gray-200">
          <div className="flex flex-col md:flex-row gap-4">
            {/* Search */}
            <div className="flex-1 relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
              <input
                type="text"
                placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              />
            </div>
            
            {/* Filter */}
            <div className="flex space-x-2">
              {[
                { key: 'active', label: '–ê–∫—Ç–∏–≤–Ω—ã–µ', icon: Activity, count: stats.active },
                { key: 'recurring', label: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ', icon: Repeat, count: stats.recurring },
                { key: 'completed', label: '–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ', icon: Check, count: stats.completed },
                { key: 'all', label: '–í—Å–µ', icon: Filter, count: stats.total }
              ].map(({ key, label, icon: Icon, count }) => (
                <button
                  key={key}
                  onClick={() => setFilter(key)}
                  className={`flex items-center space-x-2 px-4 py-2 rounded-xl transition-all duration-200 relative ${
                    filter === key
                      ? 'bg-indigo-500 text-white shadow-lg'
                      : 'bg-white text-gray-600 hover:bg-gray-50 border border-gray-200'
                  }`}
                >
                  <Icon className="w-4 h-4" />
                  <span>{label}</span>
                  {count > 0 && (
                    <span className={`text-xs px-2 py-1 rounded-full ${
                      filter === key ? 'bg-white/20' : 'bg-gray-100'
                    }`}>
                      {count}
                    </span>
                  )}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* Task List */}
        <div className="space-y-4">
          {filteredTasks.map(task => (
            <TaskCard
              key={task.id}
              task={task}
              onToggleStatus={toggleTaskStatus}
              onAddComment={addComment}
              onDelete={deleteTask}
              onEdit={setEditingTask}
              getPriorityColor={getPriorityColor}
              getCategoryIcon={getCategoryIcon}
              formatDate={formatDate}
              isOverdue={isOverdue}
            />
          ))}
          
          {filteredTasks.length === 0 && (
            <div className="text-center py-12">
              <div className="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                <Target className="w-8 h-8 text-gray-400" />
              </div>
              <p className="text-gray-500 text-lg">
                {filter === 'completed' ? '–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á' : 
                 filter === 'recurring' ? '–ù–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∑–∞–¥–∞—á' : '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á'}
              </p>
              <p className="text-gray-400 text-sm mt-2">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!</p>
            </div>
          )}
        </div>
      </div>

      {/* Add Task Modal */}
      {showAddForm && (
        <AddTaskModal
          newTask={newTask}
          setNewTask={setNewTask}
          onAdd={addTask}
          onClose={() => setShowAddForm(false)}
        />
      )}

      {/* Settings Modal */}
      {showSettings && (
        <SettingsModal
          settings={settings}
          setSettings={setSettings}
          onClose={() => setShowSettings(false)}
          onExport={exportTasks}
          onImport={importTasks}
          notificationsEnabled={notificationsEnabled}
          stats={stats}
        />
      )}
    </div>
  );
};

const TaskCard = ({ task, onToggleStatus, onAddComment, onDelete, onEdit, getPriorityColor, getCategoryIcon, formatDate, isOverdue }) => {
  const [showComments, setShowComments] = useState(false);
  const [newComment, setNewComment] = useState('');

  const handleAddComment = () => {
    onAddComment(task.id, newComment);
    setNewComment('');
  };

  const isTaskOverdue = isOverdue(task.dueDate) && task.status === 'active';

  return (
    <div className={`bg-white/80 backdrop-blur-sm rounded-2xl border-l-4 ${getPriorityColor(task.priority)} shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden ${
      isTaskOverdue ? 'ring-2 ring-red-200 bg-red-50/50' : ''
    }`}>
      <div className="p-6">
        {/* Header */}
        <div className="flex items-start justify-between mb-4">
          <div className="flex items-start space-x-3 flex-1">
            <button
              onClick={() => onToggleStatus(task.id)}
              className={`mt-1 flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-200 ${
                task.status === 'completed'
                  ? 'bg-green-500 border-green-500 text-white'
                  : 'border-gray-300 hover:border-indigo-500 hover:bg-indigo-50'
              }`}
            >
              {task.status === 'completed' && <Check className="w-4 h-4" />}
            </button>
            
            <div className="flex-1">
              <div className="flex items-center space-x-2 mb-2">
                <span className="text-lg">{getCategoryIcon(task.category)}</span>
                {task.isRecurring && <Repeat className="w-4 h-4 text-blue-500" title="–ü–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –∑–∞–¥–∞—á–∞" />}
                {task.reminderEnabled && <Bell className="w-4 h-4 text-green-500" title="–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã" />}
                {isTaskOverdue && <AlertTriangle className="w-4 h-4 text-red-500" title="–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ!" />}
                <h3 className={`text-lg font-semibold ${task.status === 'completed' ? 'line-through text-gray-500' : isTaskOverdue ? 'text-red-700' : 'text-gray-800'}`}>
                  {task.title}
                </h3>
              </div>
              
              {task.description && (
                <p className={`text-gray-600 mb-3 ${task.status === 'completed' ? 'line-through' : ''}`}>
                  {task.description}
                </p>
              )}
              
              <div className="flex flex-wrap items-center gap-3 text-sm text-gray-500">
                <span className="flex items-center space-x-1">
                  <Calendar className="w-4 h-4" />
                  <span>–°–æ–∑–¥–∞–Ω–æ: {formatDate(task.createdAt)}</span>
                </span>
                
                {task.dueDate && (
                  <span className={`flex items-center space-x-1 ${isTaskOverdue ? 'text-red-500 font-medium' : ''}`}>
                    <Clock className="w-4 h-4" />
                    <span>
                      {isTaskOverdue ? '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: ' : '–°—Ä–æ–∫: '}
                      {formatDate(task.dueDate)}
                    </span>
                  </span>
                )}
                
                {task.isRecurring && (
                  <span className="flex items-center space-x-1 text-blue-600">
                    <Repeat className="w-4 h-4" />
                    <span>
                      {task.recurringType === 'daily' ? '–ï–∂–µ–¥–Ω–µ–≤–Ω–æ' :
                       task.recurringType === 'weekly' ? '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ' : '–ï–∂–µ–º–µ—Å—è—á–Ω–æ'}
                    </span>
                  </span>
                )}
                
                {task.status === 'completed' && task.completedAt && (
                  <span className="flex items-center space-x-1 text-green-600">
                    <Check className="w-4 h-4" />
                    <span>–ó–∞–≤–µ—Ä—à–µ–Ω–æ: {formatDate(task.completedAt)}</span>
                  </span>
                )}
              </div>
            </div>
          </div>
          
          <div className="flex items-center space-x-2 ml-4">
            <div className={`w-3 h-3 rounded-full ${getPriorityColor(task.priority)}`} title={`–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${task.priority}`}></div>
            <button
              onClick={() => setShowComments(!showComments)}
              className="relative p-2 text-gray-400 hover:text-indigo-500 hover:bg-indigo-50 rounded-lg transition-colors duration-200"
            >
              <MessageSquare className="w-5 h-5" />
              {task.comments?.length > 0 && (
                <span className="absolute -top-1 -right-1 bg-indigo-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                  {task.comments.length}
                </span>
              )}
            </button>
            <button
              onClick={() => onDelete(task.id)}
              className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors duration-200"
            >
              <Trash2 className="w-5 h-5" />
            </button>
          </div>
        </div>
      </div>

      {/* Comments Section */}
      {showComments && (
        <div className="border-t border-gray-100 bg-gray-50/50 p-4">
          <div className="space-y-3 mb-4 max-h-40 overflow-y-auto">
            {task.comments?.map(comment => (
              <div key={comment.id} className="bg-white rounded-lg p-3 border border-gray-100">
                <p className="text-gray-800 text-sm mb-1">{comment.text}</p>
                <p className="text-xs text-gray-500">{formatDate(comment.timestamp)}</p>
              </div>
            ))}
          </div>
          
          <div className="flex space-x-2">
            <input
              type="text"
              placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
              value={newComment}
              onChange={(e) => setNewComment(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleAddComment()}
              className="flex-1 px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            />
            <button
              onClick={handleAddComment}
              disabled={!newComment.trim()}
              className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
            >
              <Send className="w-4 h-4" />
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

const AddTaskModal = ({ newTask, setNewTask, onAdd, onClose }) => {
  return (
    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-bold text-gray-800">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
          <button
            onClick={onClose}
            className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors duration-200"
          >
            ‚úï
          </button>
        </div>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
            <input
              type="text"
              value={newTask.title}
              onChange={(e) => setNewTask({ ...newTask, title: e.target.value })}
              placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..."
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              autoFocus
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea
              value={newTask.description}
              onChange={(e) => setNewTask({ ...newTask, description: e.target.value })}
              placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..."
              rows={3}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
            />
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
              <select
                value={newTask.priority}
                onChange={(e) => setNewTask({ ...newTask, priority: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              >
                <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                <option value="medium">üü° –°—Ä–µ–¥–Ω–∏–π</option>
                <option value="high">üî¥ –í—ã—Å–æ–∫–∏–π</option>
              </select>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select
                value={newTask.category}
                onChange={(e) => setNewTask({ ...newTask, category: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              >
                <option value="personal">üè† –õ–∏—á–Ω–æ–µ</option>
                <option value="work">üíº –†–∞–±–æ—Ç–∞</option>
                <option value="health">üí™ –ó–¥–æ—Ä–æ–≤—å–µ</option>
                <option value="study">üìö –£—á—ë–±–∞</option>
              </select>
            </div>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
            <input
              type="datetime-local"
              value={newTask.dueDate}
              onChange={(e) => setNewTask({ ...newTask, dueDate: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            />
          </div>

          <div className="space-y-3">
            <div className="flex items-center space-x-3">
              <input
                type="checkbox"
                id="isRecurring"
                checked={newTask.isRecurring}
                onChange={(e) => setNewTask({ ...newTask, isRecurring: e.target.checked })}
                className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
              />
              <label htmlFor="isRecurring" className="text-sm font-medium text-gray-700">
                üîÑ –ü–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è –∑–∞–¥–∞—á–∞
              </label>
            </div>

            {newTask.isRecurring && (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</label>
                <select
                  value={newTask.recurringType}
                  onChange={(e) => setNewTask({ ...newTask, recurringType: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                >
                  <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                  <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                  <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                </select>
              </div>
            )}

            <div className="flex items-center space-x-3">
              <input
                type="checkbox"
                id="reminderEnabled"
                checked={newTask.reminderEnabled}
                onChange={(e) => setNewTask({ ...newTask, reminderEnabled: e.target.checked })}
                className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
              />
              <label htmlFor="reminderEnabled" className="text-sm font-medium text-gray-700">
                üîî –í–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
              </label>
            </div>
          </div>
        </div>
        
        <div className="flex space-x-3 mt-6">
          <button
            onClick={onClose}
            className="flex-1 px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            onClick={onAdd}
            disabled={!newTask.title.trim()}
            className="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
          >
            –°–æ–∑–¥–∞—Ç—å
          </button>
        </div>
      </div>
    </div>
  );
};

const SettingsModal = ({ settings, setSettings, onClose, onExport, onImport, notificationsEnabled, stats }) => {
  const fileInputRef = useRef(null);

  return (
    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-bold text-gray-800">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
          <button
            onClick={onClose}
            className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors duration-200"
          >
            ‚úï
          </button>
        </div>
        
        <div className="space-y-6">
          {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
          <div className="bg-gray-50 rounded-lg p-4">
            <h3 className="font-semibold text-gray-800 mb-3">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div className="grid grid-cols-2 gap-3 text-sm">
              <div className="text-center">
                <div className="text-2xl font-bold text-indigo-600">{stats.total}</div>
                <div className="text-gray-600">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-green-600">{stats.completed}</div>
                <div className="text-gray-600">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-blue-600">{stats.recurring}</div>
                <div className="text-gray-600">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-red-600">{stats.overdue}</div>
                <div className="text-gray-600">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
              </div>
            </div>
          </div>

          {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
          <div>
            <h3 className="font-semibold text-gray-800 mb-3">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-700">–ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                <span className={`text-sm px-2 py-1 rounded ${
                  notificationsEnabled ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                }`}>
                  {notificationsEnabled ? '–í–∫–ª—é—á–µ–Ω—ã' : '–û—Ç–∫–ª—é—á–µ–Ω—ã'}
                </span>
              </div>
              
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-700">–ó–≤—É–∫–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã</span>
                <input
                  type="checkbox"
                  checked={settings.sound}
                  onChange={(e) => setSettings({ ...settings, sound: e.target.checked })}
                  className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                />
              </div>
            </div>
          </div>

          {/* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */}
          <div>
            <h3 className="font-semibold text-gray-800 mb-3">üìã –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
            <div className="flex items-center justify-between">
              <span className="text-sm text-gray-700">–£–º–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</span>
              <input
                type="checkbox"
                checked={settings.autoSort}
                onChange={(e) => setSettings({ ...settings, autoSort: e.target.checked })}
                className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
              />
            </div>
            <p className="text-xs text-gray-500 mt-1">
              –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∏ –≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏
            </p>
          </div>

          {/* –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ */}
          <div>
            <h3 className="font-semibold text-gray-800 mb-3">üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <div className="space-y-3">
              <button
                onClick={onExport}
                className="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200"
              >
                <Download className="w-4 h-4" />
                <span>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
              </button>
              
              <button
                onClick={() => fileInputRef.current?.click()}
                className="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200"
              >
                <Upload className="w-4 h-4" />
                <span>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
              </button>
              
              <input
                ref={fileInputRef}
                type="file"
                accept=".json"
                onChange={onImport}
                className="hidden"
              />
            </div>
          </div>

          {/* PWA Info */}
          <div className="bg-indigo-50 rounded-lg p-4">
            <h3 className="font-semibold text-indigo-800 mb-2">üì± –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
            <p className="text-sm text-indigo-700 mb-2">
              –î–æ–±–∞–≤—å—Ç–µ TaskMaster Pro –Ω–∞ –¥–æ–º–∞—à–Ω–∏–π —ç–∫—Ä–∞–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!
            </p>
            <p className="text-xs text-indigo-600">
              Chrome/Edge: –ú–µ–Ω—é ‚Üí "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"<br/>
              Safari: –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí "–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª"
            </p>
          </div>
        </div>
        
        <div className="flex justify-end mt-6">
          <button
            onClick={onClose}
            className="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors duration-200"
          >
            –ì–æ—Ç–æ–≤–æ
          </button>
        </div>
      </div>
    </div>
  );
};

export default UltimateTaskPlanner;